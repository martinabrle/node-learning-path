name: express-postgresql-app-ci

on:
  workflow_dispatch

defaults:
  run:
    working-directory: ./express-postgresql-app
    
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PACKAGE_VERSION: "1.0.0"
      PACKAGE_FILE_NAME: "express-postgresql-app.zip"
      PACKAGE_FILE_NAME_NO_EXT: "express-postgresql-app"
    steps:
      - uses: actions/checkout@v2
        
      - name: Validate deployment template(s)
        run: az bicep build --file ./scripts/deployment-uat.bicep
        
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16
          registry-url: https://npm.pkg.github.com
          
      - name: Restore all project dependencies
        run: npm install
      
      - name: Generate a unique package version
        id: get_version_info
        run: |
        
          declare origPackageVersion=""
          declare packageVersion=""
          declare packageFileName=""
          declare packageFileNameNoExt=""
          
          origPackageVersion=$(cat ./package.json | jq '.version')
          origPackageVersion="${origPackageVersion%\"}"
          origPackageVersion="${origPackageVersion#\"}"
          packageVersion="${origPackageVersion}.${{github.run_number}}"
          echo "Original package version: : $origPackageVersion"
          echo "New package version: $packageVersion"
          cat ./package.json | jq ". |= . + { \"version\": \"${packageVersion}\" }" > ./package.new.json
          mv ./package.json ./package.old.json
          mv ./package.new.json ./package.json
          rm ./package.old.json
          
          packageFileName="express-postgresql-app-${packageVersion}.zip"
          packageFileNameNoExt="express-postgresql-app-${packageVersion}"
          
          echo 'PACKAGE_VERSION="{$packageVersion}' >> $GITHUB_ENV
          echo 'PACKAGE_FILE_NAME="{$packageFileName}' >> $GITHUB_ENV
          echo 'PACKAGE_FILE_NAME_NO_EXT="{$packageFileNameNoExt}' >> $GITHUB_ENV
          
      - name: Build and validate
        run: npm run build
      
      - name: Run unit tests
        run: npm run test
      
      - name: Remove test artifacts
        run: |
          rm -rf node_modules
          npm install --production
        
      - name: Publish a package
        run: npm publish --tag {{$github.sha}}
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Create an application archive
        run: |
         zip -q -m "../${{ steps.get_version_info.PACKAGE_FILE_NAME }}" ../express-postgresql-app
      
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.PACKAGE_FILE_NAME }}
          tag_name: ${{ env.PACKAGE_FILE_NAME_NO_EXT }}
          files: ${{ env.PACKAGE_FILE_NAME }}
          token: ${{ secrets.PAT_TOKEN }} # To trigger other workflows

      # No longer supported:
      #- name: Create Release
      #  id: create_release
      #  uses: actions/create-release@v1
      #  env:
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #  with:
      #    tag_name: ${{ env.PACKAGE_VERSION }}
      #    release_name: ${{ env.PACKAGE_VERSION }}
      #    body: "Express-postgresql-app Version ${{ env.PACKAGE_VERSION }}"
      #    draft: false
      #    prerelease: true
          
      #- name: Upload Release Asset
      #  id: upload-release-asset
      #  uses: actions/upload-release-asset@v1
      #  env:
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #    UPLOAD_URL: ${{ steps.create_release.outputs.upload_url }}
      #    filename: "./${{ env.PACKAGE_FILE_NAME }}"
      #  with:
      #    upload_url: ${{ steps.create_release.outputs.upload_url }}
      #    asset_path: "./${{ env.PACKAGE_FILE_NAME }}"
      #    asset_name: ${{ env.PACKAGE_FILE_NAME }}
      #    asset_content_type: application/zip
          
  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 16
          registry-url: https://npm.pkg.github.com/
      
      #- name: Azure login
       # uses: azure/login@v1
       # with:
       #   client-id: ${{ secrets.AZURE_UAT_CLIENT_ID }}
       #   tenant-id: ${{ secrets.AZURE_UAT_TENANT_ID }}
       #   subscription-id: ${{ secrets.AZURE_UAT_SUBSCRIPTION_ID }}
